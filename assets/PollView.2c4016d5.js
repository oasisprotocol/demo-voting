import{d as j,b as z,a as I,r as u,k as M,A as $,l as D,o as s,c as o,e,m as V,n as B,q as g,t as k,i as C,F as q,f as H,s as U,N as L,B as X,x as Z,C as S,y as G,w as J,z as K,p as Q,j as W,_ as Y}from"./index.4b7ee666.js";const a=m=>(Q("data-v-16611fc0"),m=m(),W(),m),ee={style:{"max-width":"60ch"},class:"p-5 m-auto"},te={class:"font-medium text-3xl mb-4"},se=a(()=>e("rect",{x:"0",y:"0.1em",rx:"3",ry:"3",width:"30ch",height:"1.3em"},null,-1)),ae={key:1},oe={key:0,class:"text-gray-500 mb-10",style:{height:"3em"}},le=a(()=>e("rect",{x:"0",y:"0.1em",rx:"3",ry:"3",width:"50ch",height:"1.1em"},null,-1)),ie=a(()=>e("rect",{x:"0",y:"1.4em",rx:"3",ry:"3",width:"45ch",height:"1.1em"},null,-1)),ne=a(()=>e("rect",{x:"0",y:"2.7em",rx:"3",ry:"3",width:"47ch",height:"1.1em"},null,-1)),re=a(()=>e("rect",{x:"0",y:"4.0em",rx:"3",ry:"3",width:"28ch",height:"1.1em"},null,-1)),ce=a(()=>e("h2",{class:"text-lg font-medium underline"},"Choices",-1)),de={key:2,class:"text-orange-600 my-2"},ue={key:0},he={class:"inline-block py-6 px-3 pr-4 w-full"},ve=["value","disabled"],pe={class:"inline-block ml-2"},_e=a(()=>e("rect",{x:"0",y:"0.1em",rx:"3",ry:"3",width:"26ch",height:"1.1em"},null,-1)),fe=a(()=>e("rect",{x:"0",y:"1.4em",rx:"3",ry:"3",width:"33ch",height:"1.1em"},null,-1)),me=a(()=>e("rect",{x:"0",y:"2.7em",rx:"3",ry:"3",width:"37ch",height:"1.1em"},null,-1)),we=a(()=>e("rect",{x:"0",y:"4.0em",rx:"3",ry:"3",width:"10ch",height:"1.1em"},null,-1)),ye={key:2,class:"error my-2"},xe=a(()=>e("span",{class:"font-bold"},"Error:",-1)),be=["disabled"],ge={key:0},ke={key:1},Ce=a(()=>e("span",null,"Close Ballot",-1)),Pe=[Ce],Ve=j({__name:"PollView",props:{id:{}},setup(m){const h=`0x${m.id}`,w=z(),r=I(),x=u(""),y=u(!1),c=u(void 0),v=u(void 0),p=u(),P=u(void 0);let A=u(!1),N=u(!1);(async()=>{const[d,l,i]=await w.value.callStatic.proposals(h),n={id:h,active:d,topChoice:i,params:l},f=await(await fetch(`https://w3s.link/ipfs/${l.ipfsHash}`)).json();c.value={proposal:n,ipfsParams:f},n.active||(p.value=v.value=n.topChoice);const t=await M(),b=r.signer?await r.signer.getAddress():$;A.value=await t.value.callStatic.canManagePoll(w.value.address,h,b),N.value=await t.value.callStatic.canVoteOnPoll(w.value.address,h,b)})();const O=D(()=>!(!r.address||v.value!==void 0||p.value===void 0||P.value!==void 0||N.value==!1)),T=D(()=>v.value!==void 0?!1:r.address===void 0?!0:P.value===void 0);async function F(){if(await r.connect(),await r.switchNetwork(L.FromConfig),(await(await w.value.closeProposal(h)).wait()).status!=1)throw new Error("close ballot tx failed")}async function E(d){var l;d.preventDefault();try{x.value="",y.value=!0,await R()}catch(i){x.value=(l=i.reason)!=null?l:i.message}finally{y.value=!1}}async function R(){var f;if(await r.connect(),p.value===void 0)throw new Error("no choice selected");const d=p.value;console.log("casting vote"),await r.switchNetwork(L.FromConfig);const i=await(await w.value.castVote(h,d)).wait();if(i.status!=1)throw new Error("cast vote tx failed");P.value=d;let n;for(const t of(f=i.events)!=null?f:[])t.address=={}.VITE_BALLOT_BOX_V1_ADDR&&t.event==="BallotClosed"&&(n=X.from(t.data).toNumber());if(n===void 0)return;v.value=n;let _=!1;for(;!_;)console.log("checking if ballot has been closed on BSC"),_=!(await Z.callStatic.proposals(h)).active,await new Promise(t=>setTimeout(t,1e3))}return r.connect(),(d,l)=>{var i,n,_;return s(),o("main",ee,[e("h1",te,[(i=c.value)!=null&&i.ipfsParams.name?(s(),o("span",ae,k(c.value.ipfsParams.name),1)):(s(),V(g(S),{key:0,width:"30",height:"3"},{default:B(()=>[se]),_:1}))]),c.value?(s(),o("p",oe,k(c.value.ipfsParams.description),1)):(s(),V(g(S),{key:1,width:"60",height:"6"},{default:B(()=>[le,ie,ne,re]),_:1})),ce,(n=c.value)!=null&&n.ipfsParams.options.publishVotes?(s(),o("p",de," Votes will be made public after voting has ended. ")):C("",!0),e("form",{onSubmit:E},[(_=c.value)!=null&&_.ipfsParams.choices?(s(),o("ul",ue,[(s(!0),o(q,null,H(c.value.ipfsParams.choices,(f,t)=>(s(),o("li",{class:G(["choice-input",{selected:p.value===t,won:t===v.value,lost:v.value!==void 0&&t!==v.value}]),key:t},[e("label",he,[J(e("input",{tabindex:"1",name:"choice",value:t,type:"radio",disabled:!T.value,"onUpdate:modelValue":l[0]||(l[0]=b=>p.value=b)},null,8,ve),[[K,p.value]]),e("span",pe,k(f),1)])],2))),128))])):(s(),V(g(S),{key:1,width:"50",height:"6"},{default:B(()=>[_e,fe,me,we]),_:1})),x.value?(s(),o("p",ye,[xe,U("\xA0"),e("span",null,k(x.value.replace("Error: ","")),1)])):C("",!0),e("button",{tabindex:"1",class:"my-3 border-2 border-blue-800 text-gray-100 rounded-md p-2 bg-blue-600 disabled:border-gray-500 disabled:text-gray-500 disabled:cursor-default disabled:bg-white transition-colors font-bold text-xl disabled:hidden",disabled:!O.value||y.value,onClick:E},[y.value?(s(),o("span",ge,"Pushing\u2026")):y.value?C("",!0):(s(),o("span",ke,"Vote"))],8,be)],32),g(A)?(s(),o("button",{key:3,tabindex:"1",class:"my-3 border-2 border-blue-800 text-gray-100 rounded-md p-2 bg-red-600 disabled:border-gray-500 disabled:text-gray-500 disabled:cursor-default disabled:bg-white transition-colors font-bold text-xl disabled:hidden",disabled:!1,onClick:F},Pe)):C("",!0)])}}});const Ae=Y(Ve,[["__scopeId","data-v-16611fc0"]]);export{Ae as default};
//# sourceMappingURL=PollView.2c4016d5.js.map
